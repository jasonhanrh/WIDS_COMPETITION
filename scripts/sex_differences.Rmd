# 5. Sex Differences Analysis

```{r}
library(tidyverse)
library(Metrics)
library(igraph)
library(ComplexHeatmap)
library(ggraph)
library(tidygraph)
library(glmnet)
library(xgboost)
library(SHAPforxgboost)
library(pdp)
library(purrr)
```

## 5.1 Prediction Error by Sex

### 5.1.1 Combine Predictions for Validation Set

To facilitate sex-stratified evaluation of model performance, we first construct a validation dataframe that merges the observed age and sex with the predicted values generated by the Ridge and XGBoost models. This enables direct comparison of prediction accuracy between male and female subgroups.

```{r}
# Filter validation set to matched participants and attach model predictions
valid_preds <- valid %>%
  filter(participant_id %in% valid_merged$participant_id) %>%
  select(participant_id, sex, age) %>%
  mutate(
    Ridge_Pred = ridge_lasso_pca_pred,  # Ridge predicted age
    XGB_Pred   = xgb_pred               # XGBoost predicted age
  )

```

### 5.1.2 Compute RMSE by Sex

To quantify the predictive performance of each model across sexes, we compute the Root Mean Squared Error (RMSE) separately for males and females. This allows us to assess whether either model systematically underperforms for a specific sex group, thereby identifying potential disparities in model accuracy.

```{r}
# Split predictions by sex
male_preds   <- valid_preds %>% filter(sex == "Male")
female_preds <- valid_preds %>% filter(sex == "Female")

# Compute RMSE for each model × sex combination
ridge_rmse_male   <- rmse(male_preds$age, male_preds$Ridge_Pred)
ridge_rmse_female <- rmse(female_preds$age, female_preds$Ridge_Pred)
xgb_rmse_male     <- rmse(male_preds$age, male_preds$XGB_Pred)
xgb_rmse_female   <- rmse(female_preds$age, female_preds$XGB_Pred)

# Summarize in a tibble
tibble(
  Model = rep(c("Ridge", "XGBoost"), each = 2),
  Sex   = rep(c("Male", "Female"), times = 2),
  RMSE  = c(ridge_rmse_male, ridge_rmse_female, xgb_rmse_male, xgb_rmse_female)
)

```

The RMSE results indicate that XGBoost outperforms Ridge regression for both male and female participants, reflecting its greater capacity to model non-linear relationships. Notably, Ridge regression yields slightly higher error for males (RMSE = 6.07) than females (RMSE = 5.72), whereas the pattern is reversed for XGBoost, with male RMSE at 2.56 and female RMSE at 2.88. This reversal suggests that prediction performance disparities across sexes are model-dependent, and motivates further exploration of feature-level differences.

### 5.1.3 Predicted vs Actual Age by Sex

To visualize prediction accuracy and potential bias, we generate scatter plots of predicted versus actual age for both Ridge and XGBoost models, stratified by sex. The 45-degree reference line facilitates assessment of systematic over- or under-prediction patterns across the male and female subgroups.

```{r}
# Scatter plot: Ridge predictions vs actual age, colored by sex
ggplot(valid_preds, aes(x = age, y = Ridge_Pred, color = sex)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  labs(title = "Ridge: Predicted vs Actual Age by Sex", color = "Sex") +
  theme_minimal()

# Scatter plot: XGBoost predictions vs actual age, colored by sex
ggplot(valid_preds, aes(x = age, y = XGB_Pred, color = sex)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  labs(title = "XGBoost: Predicted vs Actual Age by Sex", color = "Sex") +
  theme_minimal()

```

Visual comparisons of predicted versus actual age distributions reveal distinct behavioral patterns across models and sex groups. The Ridge model shows a relatively linear relationship but with substantial vertical dispersion, especially at younger ages. Male predictions tend to deviate more severely from the identity line, suggesting higher variance and underfitting in this subgroup. On the other hand, XGBoost predictions cluster more tightly, though they exhibit a clear central tendency: the model systematically underestimates age in older children while slightly overestimating it in younger ones. This “flattening” effect is indicative of regularization-induced bias and may stem from the limited variability captured by tree-based splits. Furthermore, while female predictions under both models remain closer to the identity line on average, their distribution exhibits moderate compression, reflecting potential sex-based model sensitivity.

### 5.1.4 Residual Density and Significance Tests

To further explore sex-based differences in prediction accuracy, we compute residuals (i.e., predicted age minus actual age) for both Ridge and XGBoost models and examine their distribution across sexes. Kernel density plots are used to visualize potential distributional shifts, while both parametric (t-test) and non-parametric (Wilcoxon rank-sum test) statistical tests are conducted to assess whether residuals significantly differ by sex.

```{r}
# Calculate residuals for each model
valid_preds <- valid_preds %>%
  mutate(
    Ridge_Resid = Ridge_Pred - age,
    XGB_Resid   = XGB_Pred   - age
  )

# Density plot of Ridge residuals by sex
ggplot(valid_preds, aes(x = Ridge_Resid, fill = sex)) +

### 5.2.2 Statistical Tests on Principal Components

To formally assess whether the distributions of the principal components differ significantly by sex, we conduct two-sample t-tests for each of the first five PCs. The resulting p-values are reported to quantify the evidence of sex-based separability in the learned connectome embeddings.

```{r}
# Perform t-test for each PC

```
The SHAP summary plot reveals the top predictors of age for each sex under the XGBoost model. BMI consistently emerged as the most influential feature for both males and females, followed by principal components such as PC1 and PC19. While there is general overlap in the top features across sexes, certain components (e.g., PC19, PC11) show sex-specific prominence, suggesting subtle differences in how feature importance contributes to model predictions.

## 5.4 Connectome Differences and Network Visualization

### 5.4.1 Heatmap of Connectivity Differences

To quantify neural connectivity differences between sexes, we compute and contrast the mean connectome vectors for male and female participants. These vectors are reconstructed into symmetric adjacency matrices and differenced to yield a sex-specific connectivity difference matrix. The resulting matrix is visualized as a heatmap, enabling identification of brain regions with elevated or diminished average connectivity across sex.

```{r}
# Extract connectome features for valid participants
valid_feats <- df %>%
  filter(participant_id %in% valid_merged$participant_id) %>%
  select(participant_id, sex, starts_with("V"))

# Compute mean connectivity vector by sex
male_mean_vec   <- valid_feats %>% filter(sex == "Male")   %>% select(starts_with("V")) %>% summarise_all(mean) %>% unlist()
female_mean_vec <- valid_feats %>% filter(sex == "Female") %>% select(starts_with("V")) %>% summarise_all(mean) %>% unlist()

# Recover adjacency matrix dimension
n <- as.integer((sqrt(8 * length(male_mean_vec) + 1) + 1) / 2)

# Build symmetric difference matrix
diff_vec <- male_mean_vec - female_mean_vec
diff_mat <- matrix(0, n, n)
diff_mat[upper.tri(diff_mat)] <- diff_vec
diff_mat <- diff_mat + t(diff_mat) - diag(diag(diff_mat))

# Visualize as heatmap
Heatmap(diff_mat, name = "Male–Female\nConnectivity")

```
The heatmap illustrates the difference in mean connectome connectivity between males and females across all brain region pairs. Warm colors (red) indicate higher average connectivity in males, while cool colors (blue) indicate stronger connectivity in females. The symmetric pattern and hierarchical clustering reveal broad but heterogeneous sex-specific differences in functional brain organization.

### 5.4.2 Subnetwork of Top Differences

To highlight the most salient structural differences, we extract the 50 connectome edges with the largest absolute sex-based discrepancies. We then construct a subgraph consisting of the associated brain regions and visualize this reduced network using a force-directed layout. Edge width and color encode the magnitude of difference, offering an interpretable and compact representation of key structural divergences.

```{r}
# Create full graph from difference matrix
g_full <- graph_from_adjacency_matrix(diff_mat,
                                      mode = "undirected",
                                      weighted = TRUE,
                                      diag = FALSE)
V(g_full)$name <- as.character(1:vcount(g_full))

# Select top 50 edges by absolute weight
edges_df <- igraph::as_data_frame(g_full, what = "edges") %>%
  as_tibble() %>%
  slice_max(abs(weight), n = 50)

# Induce subgraph on nodes involved in top edges
nodes_to_keep <- unique(c(edges_df$from, edges_df$to))
g_sub <- induced_subgraph(g_full, vids = as.integer(nodes_to_keep))
E(g_sub)$weight <- abs(E(g_sub)$weight)

# Plot subnetwork with edge width & color mapped to weight
g_sub %>%
  as_tbl_graph() %>%
  ggraph(layout = "fr") +
  geom_edge_link(aes(edge_width = weight, edge_color = weight),
                 show.legend = FALSE, alpha = 0.8) +
  scale_edge_color_gradient2(low = "blue", mid = "white", high = "red") +
  geom_node_point(size = 3) +
  geom_node_text(aes(label = name), repel = TRUE, size = 3) +
  theme_graph() +
  labs(title = "Subnet: Top 50 Male–Female Connectivity Differences")

```
We constructed a subnetwork comprising the 50 brain connections with the largest absolute differences in mean connectivity between male and female participants. The resulting graph reveals that connectivity differences are not randomly scattered but instead concentrated around a few hub-like nodes, such as Node 192, 61, and 69. These nodes exhibit disproportionately higher connectivity divergence and may play a central role in sex-specific brain development. Moreover, the asymmetrical and dense structure of this subgraph suggests localized rather than global sex differences in connectome organization. These findings highlight potential regions of interest for future neurobiological investigations into sex-related functional specialization.

### 5.4.3 Barplot of Top 10 Connectivity Differences

For further clarity, we summarize the top 10 brain region pairs with the largest sex-based differences in connectome strength. This barplot provides a ranked view of the most prominent edges contributing to network-level distinctions between male and female participants.

```{r}
# Barplot for the 10 largest absolute connectivity differences
edges_df %>%
  mutate(pair = paste0(from, "–", to)) %>%
ex difference, with an absolute divergence exceeding 0.15. Several other region pairs involving node 61 (e.g., 61–76, 61–78, 61–69) also appear prominently, reinforcing its potential role as a sex-sensitive hub. These findings complement the subnetwork visualization and suggest that specific neural circuits, rather than diffuse patterns, account for most of the observed sex-based connectivity disparities. Such localized differences may be critical for understanding functional specialization in brain development across sexes.

## 5.5 Summary of Sex Differences Findings

Our analysis revealed several notable sex differences in both predictive performance and brain network characteristics. First, while Ridge regression exhibited slightly better RMSE in females, XGBoost showed superior performance in males, suggesting potential disparities in model fit or neurodevelopmental patterns across sexes. Residual distribution plots and statistical tests further indicated that the Ridge model tended to systematically underpredict female ages relative to males.

Principal component analysis (PCA) on connectome features showed a statistically significant difference in the first component (PC1) between sexes, indicating that overall connectome structure partially encodes sex-specific variation. Partial dependence plots (PDP) and SHAP analysis also revealed divergent patterns of feature importance; for example, BMI had a stronger marginal effect on age prediction in males than in females, and different metadata features ranked highest in SHAP importance across sexes.

Finally, comparison of average connectome vectors identified brain regions with the largest sex-specific connectivity differences. A subnetwork of the top 50 connections demonstrated concentrated divergence around specific hubs, such as Node 192 and Node 61, suggesting localized rather than diffuse sex-based structural differences.

Together, these findings support the hypothesis that male and female brain networks follow distinct developmental trajectories during adolescence. This underscores the importance of sex-specific modeling in neurodevelopmental research and highlights potential regions of interest for future investigation into brain-based biomarkers of psychiatric risk.
